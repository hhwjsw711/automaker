- name: Build server
  run: npm run build --workspace=apps/server

- name: Set up Git user
  run: |
    git config --global user.name "GitHub CI"
    git config --global user.email "ci@example.com"

- name: Start backend server
  run: npm run start --workspace=apps/server &
  env:
    PORT: 3008
    NODE_ENV: test
    # Use a deterministic API key so Playwright can log in reliably
    AUTOMAKER_API_KEY: test-api-key-for-e2e-tests
    # Reduce log noise in CI
    AUTOMAKER_HIDE_API_KEY: 'true'
    # Avoid real API calls during CI
    AUTOMAKER_MOCK_AGENT: 'true'
    # Simulate containerized environment to skip sandbox confirmation dialogs
    IS_CONTAINERIZED: 'true'

- name: Wait for backend server
  run: |
    echo "Waiting for backend server to be ready..."
    for i in {1..60}; do
      if curl -s -f http://localhost:3008/api/health > /dev/null 2>&1; then
        echo "Backend server is ready!"
        curl -s http://localhost:3008/api/health | jq . 2>/dev/null || echo "Health check response: $(curl -s http://localhost:3008/api/health 2>/dev/null || echo 'No response')"
        exit 0
      fi
      echo "Waiting... ($i/60)"
      sleep 1
    done
    echo "Backend server failed to start!"
    echo "Checking server status..."
    ps aux | grep -E "(node|tsx)" | grep -v grep || echo "No node processes found"
    netstat -tlnp 2>/dev/null | grep :3008 || echo "Port 3008 not listening"
    echo "Testing health endpoint..."
    curl -v http://localhost:3008/api/health 2>&1 || echo "Health endpoint failed"
    exit 1
